

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Opus Codec &mdash; webrtc_tutorial 1 documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="WebRTC 视频" href="webrtc_video.html" />
    <link rel="prev" title="Audio Analysis" href="audio_analysis.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> webrtc_tutorial
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../outline.html">目录</a></li>
<li class="toctree-l1"><a class="reference internal" href="../1.basic/index.html">1. WebRTC 基础</a></li>
<li class="toctree-l1"><a class="reference internal" href="../2.transport/index.html">2. WebRTC 传输</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">3. WebRTC 媒体</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="overview.html">WebRTC 媒体概论</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="webrtc_audio.html">WebRTC 音频</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="audio_basic.html">Audio Basic</a></li>
<li class="toctree-l3"><a class="reference internal" href="audio_level.html">Audio Level</a></li>
<li class="toctree-l3"><a class="reference internal" href="audio_api.html">Web Audio API</a></li>
<li class="toctree-l3"><a class="reference internal" href="audio_qos.html">Audio QoS</a></li>
<li class="toctree-l3"><a class="reference internal" href="audio_aec.html">Acoustic Echo Canceller</a></li>
<li class="toctree-l3"><a class="reference internal" href="audio_vad.html">Voice Activity Detector</a></li>
<li class="toctree-l3"><a class="reference internal" href="audio_agc.html">Automatic Gain Control</a></li>
<li class="toctree-l3"><a class="reference internal" href="audio_ans.html">Automatic Noise Suppression</a></li>
<li class="toctree-l3"><a class="reference internal" href="audio_worklet.html">Audio worklet</a></li>
<li class="toctree-l3"><a class="reference internal" href="audio_quality.html">Audio Quality</a></li>
<li class="toctree-l3"><a class="reference internal" href="audio_analysis.html">Audio Analysis</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Opus Codec</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id2">概述</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id3">互联网音频编码需求</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id8">术语</a></li>
<li class="toctree-l4"><a class="reference internal" href="#opus-architecture">Opus Architecture</a></li>
<li class="toctree-l4"><a class="reference internal" href="#opus-frame-size-and-timestamp-increments">Opus frame size and timestamp increments</a></li>
<li class="toctree-l4"><a class="reference internal" href="#control-parameters">Control Parameters</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id9">内部分帧</a></li>
<li class="toctree-l4"><a class="reference internal" href="#opus-decoder">Opus Decoder 解码</a></li>
<li class="toctree-l4"><a class="reference internal" href="#opus-encoder">Opus Encoder 编码</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id11">SDP</a></li>
<li class="toctree-l4"><a class="reference internal" href="#api">API</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id12">参考资料</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="webrtc_audio.html#overview">Overview</a></li>
<li class="toctree-l3"><a class="reference internal" href="webrtc_audio.html#plc">PLC</a></li>
<li class="toctree-l3"><a class="reference internal" href="webrtc_audio.html#reference">Reference</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="webrtc_video.html">WebRTC 视频</a></li>
<li class="toctree-l2"><a class="reference internal" href="webrtc_qos.html">WebRTC QoS</a></li>
<li class="toctree-l2"><a class="reference internal" href="webrtc_fec.html">WebRTC FEC</a></li>
<li class="toctree-l2"><a class="reference internal" href="webrtc_rtx.html">WebRTC RTX</a></li>
<li class="toctree-l2"><a class="reference internal" href="webrtc_rcc.html">WebRTC 拥塞控制</a></li>
<li class="toctree-l2"><a class="reference internal" href="jitter_buffer.html">Jitter Buffer</a></li>
<li class="toctree-l2"><a class="reference internal" href="insertable_stream.html">Insertable Stream</a></li>
<li class="toctree-l2"><a class="reference internal" href="web_codec.html">Web Codecs</a></li>
<li class="toctree-l2"><a class="reference internal" href="web_transport.html">Web Transport</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../4.practice/index.html">4. WebRTC 实践</a></li>
<li class="toctree-l1"><a class="reference internal" href="../5.tool/index.html">5. WebRTC 工具</a></li>
<li class="toctree-l1"><a class="reference internal" href="../6.misc/index.html">6. WebRTC 关联技术</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">webrtc_tutorial</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="index.html">3. WebRTC 媒体</a> &raquo;</li>
        
          <li><a href="webrtc_audio.html">WebRTC 音频</a> &raquo;</li>
        
      <li>Opus Codec</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../_sources/3.media/opus.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="opus-codec">
<h1>Opus Codec<a class="headerlink" href="#opus-codec" title="Permalink to this headline">¶</a></h1>
<table class="docutils align-default">
<colgroup>
<col style="width: 48%" />
<col style="width: 52%" />
</colgroup>
<tbody>
<tr class="row-odd"><td><p><strong>Abstract</strong></p></td>
<td><p>Opus Codec</p></td>
</tr>
<tr class="row-even"><td><p><strong>Authors</strong></p></td>
<td><p>Walter Fan</p></td>
</tr>
<tr class="row-odd"><td><p><strong>Status</strong></p></td>
<td><p>WIP</p></td>
</tr>
<tr class="row-even"><td><p><strong>Updated</strong></p></td>
<td><p>2021-12-02</p></td>
</tr>
</tbody>
</table>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><p><a class="reference internal" href="#id2" id="id15">概述</a></p></li>
<li><p><a class="reference internal" href="#id3" id="id16">互联网音频编码需求</a></p>
<ul>
<li><p><a class="reference internal" href="#id4" id="id17">定义</a></p></li>
<li><p><a class="reference internal" href="#id5" id="id18">应用场景</a></p></li>
<li><p><a class="reference internal" href="#id6" id="id19">详细的基本需求</a></p></li>
<li><p><a class="reference internal" href="#id7" id="id20">其他的考虑</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#id8" id="id21">术语</a></p></li>
<li><p><a class="reference internal" href="#opus-architecture" id="id22">Opus Architecture</a></p>
<ul>
<li><p><a class="reference internal" href="#opus-codec-bandwidth" id="id23">Opus Codec bandwidth</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#opus-frame-size-and-timestamp-increments" id="id24">Opus frame size and timestamp increments</a></p></li>
<li><p><a class="reference internal" href="#control-parameters" id="id25">Control Parameters</a></p>
<ul>
<li><p><a class="reference internal" href="#fec" id="id26">FEC</a></p></li>
<li><p><a class="reference internal" href="#discontinuous-transmission-dtx" id="id27">Discontinuous Transmission (DTX)</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#id9" id="id28">内部分帧</a></p>
<ul>
<li><p><a class="reference internal" href="#toc" id="id29">TOC</a></p></li>
<li><p><a class="reference internal" href="#id10" id="id30">帧打包</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#opus-decoder" id="id31">Opus Decoder 解码</a></p></li>
<li><p><a class="reference internal" href="#opus-encoder" id="id32">Opus Encoder 编码</a></p></li>
<li><p><a class="reference internal" href="#id11" id="id33">SDP</a></p>
<ul>
<li><p><a class="reference internal" href="#example" id="id34">Example</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#api" id="id35">API</a></p></li>
<li><p><a class="reference internal" href="#id12" id="id36">参考资料</a></p></li>
</ul>
</div>
<div class="section" id="id2">
<h2><a class="toc-backref" href="#id15">概述</a><a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h2>
<p>Opus 是一种实时交互音频编码， 设计用来满足在 <a class="reference external" href="https://tools.ietf.org/html/rfc6366">RFC6366</a>  中所提出的对互联网音频编码的需求.
不稳定的网络环境下的高质量语音通信.</p>
<p>Opus 由基于线性预测 (LP)的层和基于修正离散余弦变换 (MDCT)的层组成。</p>
<p>使用两层背后的主要思想是：对于语音，线性预测技术（如代码激励线性预测 CELP）的低频率编码比变换（例如，MDCT）域技术更加有效，而对于音乐和更高频率的语音，情况则正相反。</p>
<p>因此，具有两层可用的编解码器可操作范围比任何单个一层都大，将它们组合在一起比起单独使用任何一个能实现更好的质量。</p>
<p>本规范的主要规范部分由附录 A 中的源代码提供。只有该软件的解码器部分是规范的，尽管编码器和解码器共享大量代码。第 6 节提供了解码器一致性测试。解码器包含大量需要精确执行的整数和定点算术，包括所有舍入考虑，因此任何有用的规范都需要特定领域的符号语言来充分定义这些操作。此外，必须解决符号表示与包含的参考实现之间的任何冲突。出于兼容性和可测试性的实际原因，在任何分歧中给予参考实现优先级将是有利的。 C 语言也是机器行为的最广泛理解、人类可读的符号表示之一。由于这些原因，本 RFC 使用参考实现作为编解码器的唯一符号表示。</p>
<p>虽然符号表示是明确和完整的，但它并不总是理解编解码器操作的最简单方法。出于这个原因，本文档还以散文的形式描述了编解码器的重要部分，并借此机会解释了许多更令人惊讶的设计元素背后的基本原理。这些描述旨在准确和提供信息，但普通英语的局限性有时会导致歧义，因此预计读者将始终与符号表示一起阅读。为此提供了许多对实现的引用。这些描述有时在排序或数学简化方面与参考文献不同，只要这种偏差使解释更容易理解。例如，参考实现中的右移和左移操作在文本中经常使用除法和乘法来描述。一般来说，文本侧重于“什么”和“为什么”，而符号表示最清楚地提供了“如何”。</p>
<p>Opus可以处理各种音频应用，包括IP语音，视频会议，游戏内聊天，甚至远程现场音乐表演。它可以从低比特率窄带语音扩展到非常高质量的立体声音乐。支持的特性包括：</p>
<ul class="simple">
<li><p>比特率从 6kb/s 到 510 kb/s</p></li>
<li><p>采样率从 8kHz（窄带）到 48kHz（全频段）</p></li>
<li><p>帧大小从 2.5ms 到 60ms</p></li>
<li><p>支持恒定比特率（CBR）和可变比特率（VBR）</p></li>
<li><p>从窄带到全频带的音频带宽</p></li>
<li><p>支持语音和音乐</p></li>
<li><p>支持单声道和立体声</p></li>
<li><p>支持多达255个通道（多流帧）</p></li>
<li><p>动态可调比特率，音频带宽和帧大小</p></li>
<li><p>良好的稳健性和隐蔽性</p></li>
<li><p>浮点和定点实现</p></li>
</ul>
</div>
<div class="section" id="id3">
<h2><a class="toc-backref" href="#id16">互联网音频编码需求</a><a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h2>
<p><a class="reference external" href="https://tools.ietf.org/html/rfc6366">Requirements for an Internet Audio Codec</a></p>
<div class="section" id="id4">
<h3><a class="toc-backref" href="#id17">定义</a><a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>Narrowband: 8 kilohertz (kHz)</p></li>
<li><p>Wideband: 16 kHz</p></li>
<li><p>Super-wideband: 24/32 kHz</p></li>
<li><p>Full-band: 44.1/48 kHz</p></li>
</ul>
</div>
<div class="section" id="id5">
<h3><a class="toc-backref" href="#id18">应用场景</a><a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>Point-to-point calls</p></li>
<li><p>Conferencing</p></li>
<li><p>Telepresence</p></li>
<li><p>Teleoperation</p></li>
<li><p>In-game voice chat</p></li>
<li><p>Live distributed music performances / Internet music lessons</p></li>
<li><p>Delay-tolerant networking or push-to-talk services</p></li>
<li><p>Other applications</p></li>
</ul>
</div>
<div class="section" id="id6">
<h3><a class="toc-backref" href="#id19">详细的基本需求</a><a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>操作空间</p></li>
<li><p>质量和比特率</p></li>
<li><p>丢包健壮性</p></li>
<li><p>计算资源</p></li>
</ul>
</div>
<div class="section" id="id7">
<h3><a class="toc-backref" href="#id20">其他的考虑</a><a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>混音的低复杂性</p></li>
<li><p>编码的潜在改进</p></li>
<li><p>分层的比特流</p></li>
<li><p>部分的冗余</p></li>
<li><p>立体声支持</p></li>
<li><p>比特错误的健壮性</p></li>
<li><p>时间的拉长和缩短</p></li>
<li><p>输入的健壮性</p></li>
<li><p>对音频识别的支持</p></li>
<li><p>对传统的兼容</p></li>
</ul>
</div>
</div>
<div class="section" id="id8">
<h2><a class="toc-backref" href="#id21">术语</a><a class="headerlink" href="#id8" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>bitrate 比特每秒</p></li>
<li><p>complexity 复杂度从1到10，复杂度最高为10</p></li>
<li><p>signal_type 信号类型有 OPUS_AUTO, OPUS_SIGNAL_VOICE 或 OPUS_SIGNAL_MUSIC</p></li>
<li><p>audio_frame 以 opus_int16 或 float 数据类型的音频数据</p></li>
<li><p>frame_size  音频帧的长度，也是就所包含的采样数(per channel)</p></li>
</ul>
<p>例如 48 kHz 所允许的值有 120, 240, 480, 960, 1920, 和 2880
传入一个小于 10 ms(以 48 kHz 为例是 480 个采样) 会阻止编码器使用 LPC 或混合模式</p>
<ul class="simple">
<li><p>packet 音频数据包是一个包含压缩数据的字节数组</p></li>
<li><p>max_packet 最大数据包是指音频数据包可以包含的最大的字节数  (最大为 4000 字节).</p></li>
</ul>
<p>不要使用 max_packet 来控制目标可变比特率，用 OPUS_SET_BITRATE 来代替</p>
</div>
<div class="section" id="opus-architecture">
<h2><a class="toc-backref" href="#id22">Opus Architecture</a><a class="headerlink" href="#opus-architecture" title="Permalink to this headline">¶</a></h2>
<p>Opus 的整体架构</p>
<div class="section" id="opus-codec-bandwidth">
<h3><a class="toc-backref" href="#id23">Opus Codec bandwidth</a><a class="headerlink" href="#opus-codec-bandwidth" title="Permalink to this headline">¶</a></h3>
<p>Opus 编码可从 6 kbit/s 窄带单声道语音扩展到 510 kbit/s 全带立体声音乐， 其算法延迟范围从5 ms 到 65.2 ms。在给定的时间，或者 LP 层，或者 MDCT 层，或者两者都有应用。它可无缝地在它的各种操作模式之间切换，这给它很大的灵活性来适应各种内容和网络条件，而无需重新协商当前的会话。</p>
<p>此编码允许输入和输出多种不同的音频带宽，定义如下：</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 34%" />
<col style="width: 27%" />
<col style="width: 39%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Abbreviation</p></th>
<th class="head"><p>Audio Bandwidth</p></th>
<th class="head"><p>Sample Rate (Effective)</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>NB (narrowband)</p></td>
<td><p>4 kHz</p></td>
<td><p>8 kHz</p></td>
</tr>
<tr class="row-odd"><td><p>MB (medium-band)</p></td>
<td><p>6 kHz</p></td>
<td><p>12 kHz</p></td>
</tr>
<tr class="row-even"><td><p>WB (wideband)</p></td>
<td><p>8 kHz</p></td>
<td><p>16 kHz</p></td>
</tr>
<tr class="row-odd"><td><p>SWB (super-wideband)</p></td>
<td><p>12 kHz</p></td>
<td><p>24 kHz</p></td>
</tr>
<tr class="row-even"><td><p>FB (fullband)</p></td>
<td><p>20 kHz (*)</p></td>
<td><p>48 kHz</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="section" id="opus-frame-size-and-timestamp-increments">
<h2><a class="toc-backref" href="#id24">Opus frame size and timestamp increments</a><a class="headerlink" href="#opus-frame-size-and-timestamp-increments" title="Permalink to this headline">¶</a></h2>
<table class="docutils align-default">
<colgroup>
<col style="width: 16%" />
<col style="width: 29%" />
<col style="width: 9%" />
<col style="width: 9%" />
<col style="width: 9%" />
<col style="width: 9%" />
<col style="width: 10%" />
<col style="width: 10%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Mode</p></th>
<th class="head"><p>fs</p></th>
<th class="head"><p>2.5</p></th>
<th class="head"><p>5</p></th>
<th class="head"><p>10</p></th>
<th class="head"><p>20</p></th>
<th class="head"><p>40</p></th>
<th class="head"><p>60</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>ts incr</p></td>
<td><p>all</p></td>
<td><p>120</p></td>
<td><p>240</p></td>
<td><p>480</p></td>
<td><p>960</p></td>
<td><p>1920</p></td>
<td><p>2880</p></td>
</tr>
<tr class="row-odd"><td><p>voice</p></td>
<td><p>NB/MB/WB/SWB/FB</p></td>
<td><p>x</p></td>
<td><p>x</p></td>
<td><p>o</p></td>
<td><p>o</p></td>
<td><p>o</p></td>
<td><p>o</p></td>
</tr>
<tr class="row-even"><td><p>audio</p></td>
<td><p>NB/WB/SWB/FB</p></td>
<td><p>o</p></td>
<td><p>o</p></td>
<td><p>o</p></td>
<td><p>o</p></td>
<td><p>x</p></td>
<td><p>x</p></td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="control-parameters">
<h2><a class="toc-backref" href="#id25">Control Parameters</a><a class="headerlink" href="#control-parameters" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>bitrate</p></li>
<li><p>channels</p></li>
<li><p>audio Bandwidth</p></li>
<li><p>frame duration</p></li>
<li><p>complexity</p></li>
<li><p>packetloss resilience</p></li>
<li><p>FEC</p></li>
<li><p>Constant/Variable bitrate</p></li>
<li><p>DTX</p></li>
</ul>
<div class="section" id="fec">
<h3><a class="toc-backref" href="#id26">FEC</a><a class="headerlink" href="#fec" title="Permalink to this headline">¶</a></h3>
<p>In-band Forward Error Correction (FEC)</p>
<p>Packets that are determined to contain perceptually important speech information, such as onsets or transients,
are encoded again at a lower bitrate and this re-encoded information is added to a subsequent packet.</p>
</div>
<div class="section" id="discontinuous-transmission-dtx">
<h3><a class="toc-backref" href="#id27">Discontinuous Transmission (DTX)</a><a class="headerlink" href="#discontinuous-transmission-dtx" title="Permalink to this headline">¶</a></h3>
<p>Discontinuous Transmission (DTX) reduces the bitrate during silence or background noise.
When DTX is enabled, only one frame is encoded every 400 milliseconds.</p>
</div>
</div>
<div class="section" id="id9">
<h2><a class="toc-backref" href="#id28">内部分帧</a><a class="headerlink" href="#id9" title="Permalink to this headline">¶</a></h2>
<p>Opus 编码打包到 RTP payload中，可以包含一个或几个帧 frame, 需要关注几个问题</p>
<ul class="simple">
<li><p>operation mode</p></li>
<li><p>audio bandwidth</p></li>
<li><p>frame size</p></li>
<li><p>channel count</p></li>
</ul>
<div class="section" id="toc">
<h3><a class="toc-backref" href="#id29">TOC</a><a class="headerlink" href="#toc" title="Permalink to this headline">¶</a></h3>
<p>Opus 包必需包含最少一个字节，这个字节称为 TOC(Table Of Contents) 内容表，用来指示这个包所采用的模式和配置</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">0</span>
<span class="mi">0</span> <span class="mi">1</span> <span class="mi">2</span> <span class="mi">3</span> <span class="mi">4</span> <span class="mi">5</span> <span class="mi">6</span> <span class="mi">7</span>
<span class="o">+-+-+-+-+-+-+-+-+</span>
<span class="o">|</span> <span class="n">config</span>  <span class="o">|</span><span class="n">s</span><span class="o">|</span> <span class="n">c</span> <span class="o">|</span>
<span class="o">+-+-+-+-+-+-+-+-+</span>

<span class="n">Figure</span> <span class="mi">1</span><span class="p">:</span> <span class="n">The</span> <span class="n">TOC</span> <span class="n">Byte</span>
</pre></div>
</div>
<ul class="simple">
<li><p>前 5 个字节是 “config”, 它有最多 2^5=32 种配置，包括操作模式，音频带宽，和帧大小</p></li>
</ul>
<p>LP（SILK） 和 MDCT（CELT）层可以组合在一起为三种可能的操作模式</p>
<ol class="arabic simple">
<li><p>SILK-only mode 用于低带宽连接的音频(wide-band或更低)</p></li>
<li><p>Hybrid mode (SILK + CELT) 用于超宽带 SWB 或全宽带 FB 在一个中等带宽</p></li>
<li><p>CELT-only mode 用于低延迟的语音或音乐传输（从窄带 NB 和全宽带 FB）</p></li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">+-----------------------+-----------+-----------+-------------------+</span>
<span class="o">|</span> <span class="n">Configuration</span>         <span class="o">|</span> <span class="n">Mode</span>      <span class="o">|</span> <span class="n">Bandwidth</span> <span class="o">|</span> <span class="n">Frame</span> <span class="n">Sizes</span>       <span class="o">|</span>
<span class="o">|</span> <span class="n">Number</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>             <span class="o">|</span>           <span class="o">|</span>           <span class="o">|</span>                   <span class="o">|</span>
<span class="o">+-----------------------+-----------+-----------+-------------------+</span>
<span class="o">|</span> <span class="mf">0.</span><span class="o">..</span><span class="mi">3</span>                 <span class="o">|</span> <span class="n">SILK</span><span class="o">-</span><span class="n">only</span> <span class="o">|</span> <span class="n">NB</span>        <span class="o">|</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">60</span> <span class="n">ms</span> <span class="o">|</span>
<span class="o">|</span>                       <span class="o">|</span>           <span class="o">|</span>           <span class="o">|</span>                   <span class="o">|</span>
<span class="o">|</span> <span class="mf">4.</span><span class="o">..</span><span class="mi">7</span>                 <span class="o">|</span> <span class="n">SILK</span><span class="o">-</span><span class="n">only</span> <span class="o">|</span> <span class="n">MB</span>        <span class="o">|</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">60</span> <span class="n">ms</span> <span class="o">|</span>
<span class="o">|</span>                       <span class="o">|</span>           <span class="o">|</span>           <span class="o">|</span>                   <span class="o">|</span>
<span class="o">|</span> <span class="mf">8.</span><span class="o">..</span><span class="mi">11</span>                <span class="o">|</span> <span class="n">SILK</span><span class="o">-</span><span class="n">only</span> <span class="o">|</span> <span class="n">WB</span>        <span class="o">|</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">60</span> <span class="n">ms</span> <span class="o">|</span>
<span class="o">|</span>                       <span class="o">|</span>           <span class="o">|</span>           <span class="o">|</span>                   <span class="o">|</span>
<span class="o">|</span> <span class="mf">12.</span><span class="o">..</span><span class="mi">13</span>               <span class="o">|</span> <span class="n">Hybrid</span>    <span class="o">|</span> <span class="n">SWB</span>       <span class="o">|</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">20</span> <span class="n">ms</span>         <span class="o">|</span>
<span class="o">|</span>                       <span class="o">|</span>           <span class="o">|</span>           <span class="o">|</span>                   <span class="o">|</span>
<span class="o">|</span> <span class="mf">14.</span><span class="o">..</span><span class="mi">15</span>               <span class="o">|</span> <span class="n">Hybrid</span>    <span class="o">|</span> <span class="n">FB</span>        <span class="o">|</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">20</span> <span class="n">ms</span>         <span class="o">|</span>
<span class="o">|</span>                       <span class="o">|</span>           <span class="o">|</span>           <span class="o">|</span>                   <span class="o">|</span>
<span class="o">|</span> <span class="mf">16.</span><span class="o">..</span><span class="mi">19</span>               <span class="o">|</span> <span class="n">CELT</span><span class="o">-</span><span class="n">only</span> <span class="o">|</span> <span class="n">NB</span>        <span class="o">|</span> <span class="mf">2.5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">20</span> <span class="n">ms</span> <span class="o">|</span>
<span class="o">|</span>                       <span class="o">|</span>           <span class="o">|</span>           <span class="o">|</span>                   <span class="o">|</span>
<span class="o">|</span> <span class="mf">20.</span><span class="o">..</span><span class="mi">23</span>               <span class="o">|</span> <span class="n">CELT</span><span class="o">-</span><span class="n">only</span> <span class="o">|</span> <span class="n">WB</span>        <span class="o">|</span> <span class="mf">2.5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">20</span> <span class="n">ms</span> <span class="o">|</span>
<span class="o">|</span>                       <span class="o">|</span>           <span class="o">|</span>           <span class="o">|</span>                   <span class="o">|</span>
<span class="o">|</span> <span class="mf">24.</span><span class="o">..</span><span class="mi">27</span>               <span class="o">|</span> <span class="n">CELT</span><span class="o">-</span><span class="n">only</span> <span class="o">|</span> <span class="n">SWB</span>       <span class="o">|</span> <span class="mf">2.5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">20</span> <span class="n">ms</span> <span class="o">|</span>
<span class="o">|</span>                       <span class="o">|</span>           <span class="o">|</span>           <span class="o">|</span>                   <span class="o">|</span>
<span class="o">|</span> <span class="mf">28.</span><span class="o">..</span><span class="mi">31</span>               <span class="o">|</span> <span class="n">CELT</span><span class="o">-</span><span class="n">only</span> <span class="o">|</span> <span class="n">FB</span>        <span class="o">|</span> <span class="mf">2.5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">20</span> <span class="n">ms</span> <span class="o">|</span>
<span class="o">+-----------------------+-----------+-----------+-------------------+</span>

             <span class="n">Table</span> <span class="mi">2</span><span class="p">:</span> <span class="n">TOC</span> <span class="n">Byte</span> <span class="n">Configuration</span> <span class="n">Parameters</span>
</pre></div>
</div>
<ul>
<li><p>第 6 个比特标识为 “s”,  0 表示单声道，1表示立体声</p></li>
<li><p>剩余 2 个比特标识为 “c”, 表示每个包有几个帧</p>
<blockquote>
<div><ul class="simple">
<li><p>0: 1 frame in the packet</p></li>
<li><p>1: 2 frames in the packet, each with equal compressed size</p></li>
<li><p>2: 2 frames in the packet, with different compressed sizes</p></li>
<li><p>3: an arbitrary number of frames in the packet</p></li>
</ul>
</div></blockquote>
</li>
</ul>
</div>
<div class="section" id="id10">
<h3><a class="toc-backref" href="#id30">帧打包</a><a class="headerlink" href="#id10" title="Permalink to this headline">¶</a></h3>
<p>对于上述不同的配置 “config” , 有不同的打包方式</p>
</div>
</div>
<div class="section" id="opus-decoder">
<h2><a class="toc-backref" href="#id31">Opus Decoder 解码</a><a class="headerlink" href="#opus-decoder" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Range Decoder</p></li>
<li><p>SILK Decoder</p></li>
<li><p>Packet Loss Concealment</p></li>
<li><p>Configuration Switching</p></li>
</ul>
</div>
<div class="section" id="opus-encoder">
<h2><a class="toc-backref" href="#id32">Opus Encoder 编码</a><a class="headerlink" href="#opus-encoder" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Range Encoder</p></li>
<li><p>SILK Encoder</p></li>
<li><p>CELT Encoder</p></li>
</ul>
</div>
<div class="section" id="id11">
<h2><a class="toc-backref" href="#id33">SDP</a><a class="headerlink" href="#id11" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>maxaveragebitrate</p></li>
<li><p>maxplaybackrate</p></li>
<li><p>minptime</p></li>
<li><p>stereo</p></li>
<li><p>cbr</p></li>
<li><p>useinbandfec</p></li>
<li><p>usedtx</p></li>
<li><p>sprop-maxcapturerate</p></li>
<li><p>sprop-stereo</p></li>
</ul>
<div class="section" id="example">
<h3><a class="toc-backref" href="#id34">Example</a><a class="headerlink" href="#example" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">m</span><span class="o">=</span><span class="n">audio</span> <span class="mi">9000</span> <span class="n">RTP</span><span class="o">/</span><span class="n">SAVPF</span> <span class="mi">111</span>
<span class="n">a</span><span class="o">=</span><span class="n">rtpmap</span><span class="p">:</span><span class="mi">111</span> <span class="n">opus</span><span class="o">/</span><span class="mi">48000</span><span class="o">/</span><span class="mi">2</span>
<span class="n">a</span><span class="o">=</span><span class="n">ptime</span><span class="p">:</span><span class="mi">20</span>
<span class="n">a</span><span class="o">=</span><span class="n">maxptime</span><span class="p">:</span><span class="mi">20</span>
<span class="n">a</span><span class="o">=</span><span class="n">fmtp</span><span class="p">:</span><span class="mi">111</span> <span class="n">minptime</span><span class="o">=</span><span class="mi">20</span>
<span class="n">a</span><span class="o">=</span><span class="n">fmtp</span><span class="p">:</span><span class="mi">111</span> <span class="n">maxplaybackrate</span><span class="o">=</span><span class="mi">24000</span><span class="p">;</span> <span class="n">sprop</span><span class="o">-</span><span class="n">maxcapturerate</span><span class="o">=</span><span class="mi">24000</span><span class="p">;</span> <span class="n">maxaveragebitrate</span><span class="o">=</span><span class="mi">40000</span><span class="p">;</span> <span class="n">useinbandfec</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span> <span class="n">usedtx</span><span class="o">=</span><span class="mi">1</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="api">
<h2><a class="toc-backref" href="#id35">API</a><a class="headerlink" href="#api" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Encodes an Opus frame.</p></li>
</ul>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="c1">// 创建编码器</span>
<span class="n">OpusEncoder</span> <span class="o">*</span><span class="n">opus_encoder_create</span><span class="p">(</span>
    <span class="n">opus_int32</span> <span class="n">Fs</span><span class="p">,</span>
    <span class="kt">int</span> <span class="n">channels</span><span class="p">,</span>
    <span class="kt">int</span> <span class="n">application</span><span class="p">,</span>
    <span class="kt">int</span> <span class="o">*</span><span class="n">error</span>
<span class="p">)</span>

<span class="c1">// 修改编码器参数</span>
<span class="kt">int</span> <span class="n">opus_encoder_ctl</span><span class="p">(</span>
    <span class="n">OpusEncoder</span> <span class="o">*</span><span class="n">st</span><span class="p">,</span>
    <span class="kt">int</span> <span class="n">request</span><span class="p">,</span> <span class="p">...</span>
<span class="p">)</span>

<span class="c1">// 创建解码器</span>
<span class="n">OpusDecoder</span> <span class="o">*</span><span class="n">opus_decoder_create</span><span class="p">(</span>
    <span class="n">opus_int32</span> <span class="n">Fs</span><span class="p">,</span>
    <span class="kt">int</span> <span class="n">channels</span><span class="p">,</span>
    <span class="kt">int</span> <span class="o">*</span><span class="n">error</span>
<span class="p">)</span>

<span class="c1">// 将PCM编码成opus</span>
<span class="n">opus_int32</span> <span class="n">opus_encode</span><span class="p">(</span>
    <span class="n">OpusEncoder</span> <span class="o">*</span><span class="n">st</span><span class="p">,</span>
    <span class="k">const</span> <span class="n">opus_int16</span> <span class="o">*</span><span class="n">pcm</span><span class="p">,</span>
    <span class="kt">int</span> <span class="n">frame_size</span><span class="p">,</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
    <span class="n">opus_int32</span> <span class="n">max_data_bytes</span>
<span class="p">)</span>

<span class="c1">// 从opus中译码出PCM</span>
<span class="kt">int</span> <span class="n">opus_decode</span><span class="p">(</span>
    <span class="n">OpusDecoder</span> <span class="o">*</span><span class="n">st</span><span class="p">,</span>
    <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
    <span class="n">opus_int32</span> <span class="n">len</span><span class="p">,</span>
    <span class="n">opus_int16</span> <span class="o">*</span><span class="n">pcm</span><span class="p">,</span>
    <span class="kt">int</span> <span class="n">frame_size</span><span class="p">,</span>
    <span class="kt">int</span> <span class="n">decode_fec</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="id12">
<h2><a class="toc-backref" href="#id36">参考资料</a><a class="headerlink" href="#id12" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p><a class="reference external" href="https://tools.ietf.org/html/rfc6716">RFC6716 Definition of the Opus Audio Codec</a></p></li>
<li><p><a class="reference external" href="https://tools.ietf.org/html/rfc7587">Official Opus RTP specification - RFC 7587</a></p></li>
<li><p><a class="reference external" href="https://tools.ietf.org/html/rfc7845">Official Opus file format specification- RFC 7845</a></p></li>
<li><p><a class="reference external" href="https://tools.ietf.org/html/rfc8251">Updates to the Opus Audio Codec - RFC 8251</a></p></li>
<li><p><a class="reference external" href="https://tools.ietf.org/html/rfc8486">Ambisonics in an Ogg Opus Container - RFC 8486</a></p></li>
<li><p><a class="reference external" href="https://opus-codec.org/docs/">Documentation – Opus Codec</a></p></li>
<li><p><a class="reference external" href="https://mbd.baidu.com/ma/s/Qhnhx3tH">编解码器杂谈：浅析 Opus</a></p></li>
<li><p><a class="reference external" href="https://tools.ietf.org/html/rfc6366">互联网音频编码需求 - RFC6366</a></p></li>
</ul>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="webrtc_video.html" class="btn btn-neutral float-right" title="WebRTC 视频" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="audio_analysis.html" class="btn btn-neutral float-left" title="Audio Analysis" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2021, walter.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
  
 <script type="text/javascript">
    $(document).ready(function() {
        $(".toggle > *").hide();
        $(".toggle .header").show();
        $(".toggle .header").click(function() {
            $(this).parent().children().not(".header").toggle(400);
            $(this).parent().children(".header").toggleClass("open");
        })
    });
</script>


</body>
</html>