

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Google Congestion Control &mdash; webrtc_tutorial 1 documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> webrtc_tutorial
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../outline.html">目录</a></li>
<li class="toctree-l1"><a class="reference internal" href="../1.basic/index.html">1. WebRTC 基础</a></li>
<li class="toctree-l1"><a class="reference internal" href="../2.transport/index.html">2. WebRTC 传输</a></li>
<li class="toctree-l1"><a class="reference internal" href="index.html">3. WebRTC 媒体</a></li>
<li class="toctree-l1"><a class="reference internal" href="../4.practice/index.html">4. WebRTC 实践</a></li>
<li class="toctree-l1"><a class="reference internal" href="../5.tool/index.html">5. WebRTC 工具</a></li>
<li class="toctree-l1"><a class="reference internal" href="../6.misc/index.html">6. WebRTC 关联技术</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">webrtc_tutorial</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Google Congestion Control</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../_sources/3.media/webrtc_gcc.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="google-congestion-control">
<h1>Google Congestion Control<a class="headerlink" href="#google-congestion-control" title="Permalink to this headline">¶</a></h1>
<table class="docutils align-default">
<colgroup>
<col style="width: 32%" />
<col style="width: 68%" />
</colgroup>
<tbody>
<tr class="row-odd"><td><p><strong>Abstract</strong></p></td>
<td><p>WebRTC RTP 拥塞控制</p></td>
</tr>
<tr class="row-even"><td><p><strong>Authors</strong></p></td>
<td><p>Walter Fan</p></td>
</tr>
<tr class="row-odd"><td><p><strong>Status</strong></p></td>
<td><p>WIP</p></td>
</tr>
<tr class="row-even"><td><p><strong>Updated</strong></p></td>
<td><p>2021-11-18</p></td>
</tr>
</tbody>
</table>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><p><a class="reference internal" href="#id1" id="id19">简介</a></p>
<ul>
<li><p><a class="reference internal" href="#id4" id="id20">数学符号约定</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#id5" id="id21">1. 系统模型</a></p></li>
<li><p><a class="reference internal" href="#id6" id="id22">3. 反馈和扩展</a></p></li>
<li><p><a class="reference internal" href="#id7" id="id23">4. 发送引擎</a></p></li>
<li><p><a class="reference internal" href="#id8" id="id24">5.  基于延迟的控制</a></p>
<ul>
<li><p><a class="reference internal" href="#id9" id="id25">5.1 到达时间模型</a></p></li>
<li><p><a class="reference internal" href="#pre-filtering" id="id26">5.2.  Pre-filtering 预先过滤</a></p></li>
<li><p><a class="reference internal" href="#arrival-time-filter" id="id27">5.3 到达时间滤波器 arrival time filter</a></p></li>
<li><p><a class="reference internal" href="#the-over-use-detector" id="id28">5.4 过度使用检测器 The over-use detector</a></p></li>
<li><p><a class="reference internal" href="#rate-controller" id="id29">5.5 Rate controller</a></p></li>
<li><p><a class="reference internal" href="#parameters-settings" id="id30">5.6 Parameters settings</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#loss-based-control" id="id31">6. 基于丢包的控制器 Loss-based control</a></p></li>
<li><p><a class="reference internal" href="#id10" id="id32">参考代码</a></p></li>
<li><p><a class="reference internal" href="#id11" id="id33">参考资料</a></p></li>
</ul>
</div>
<div class="section" id="id1">
<h2><a class="toc-backref" href="#id19">简介</a><a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h2>
<p>GCC <a class="footnote-reference brackets" href="#id14" id="id2">1</a> 拥塞控制算法根据估计的拥塞状态调节发送速率。 为了估计状态，GCC 采用了一种有限状态机，该状态机由通过比较测得的单向延迟变化与动态阈值而获得的信号来驱动。</p>
<p>简而言之，当瓶颈被估计为“未充分利用 underused”时，发送速率就会增加； 当估计为“过度使用 overused”时，发送速率会降低。 当 GCC 流与 TCP 流共享瓶颈时，使用动态阈值来估计拥塞状态是解决饥饿问题的关键设计要求。</p>
<p>主要有两种方法:</p>
<ul class="simple">
<li><p>接收端控制器计算接收的比特率 <span class="math notranslate nohighlight">\(A_r\)</span>, 并将它发回给发送端，采用的算法是基于延迟的，估算出带宽会通过 REMB 消息发回给发送端</p></li>
<li><p>发送端控制器计算出不超过的 <span class="math notranslate nohighlight">\(A_r\)</span> 的目标发送比特率，采用的算法有早期基于丢包的算法，也有后期推荐的基于延迟的算法</p></li>
</ul>
<p>除了 RFC草案 <a class="reference external" href="https://datatracker.ietf.org/doc/html/draft-ietf-rmcat-gcc-02">A Google Congestion Control Algorithm for Real-Time Communication</a> 有详细阐述，在 IEEE 发布的文章 “Understanding the Dynamic Behaviour of the Google Congestion Control for RTCWeb” <a class="footnote-reference brackets" href="#id15" id="id3">2</a> 亦有所探讨。</p>
<p>基于丢包的算法</p>
<div class="section" id="id4">
<h3><a class="toc-backref" href="#id20">数学符号约定</a><a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>X_bar 变量 X，其中 X 是向量 - 通常由变量名称加上顶部的横线。</p></li>
<li><p>X_hat 对变量 X 真实值的估计 - 通常由变量名称加上顶部的抑扬音调符号标记。</p></li>
<li><p>X(i) 向量 X 的“第 i”个值 - 通常由下标 i 标记。</p></li>
<li><p>[x y z] 由元素 x、y 和 z 组成的行向量。</p></li>
<li><p>X_bar^T 向量 X_bar 的转置。</p></li>
<li><p>E{X} 随机变量 X 的期望值</p></li>
</ul>
</div>
</div>
<div class="section" id="id5">
<h2><a class="toc-backref" href="#id21">1. 系统模型</a><a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h2>
<div class="figure align-center" id="id16">
<a class="reference internal image-reference" href="../_images/gcc-architecture.png"><img alt="gcc-architecture" src="../_images/gcc-architecture.png" style="width: 1107.9px; height: 392.40000000000003px;" /></a>
<p class="caption"><span class="caption-text">GCC Architecture</span><a class="headerlink" href="#id16" title="Permalink to this image">¶</a></p>
</div>
</div>
<div class="section" id="id6">
<h2><a class="toc-backref" href="#id22">3. 反馈和扩展</a><a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>接收端：使用基于延迟的控制器， 可采用 RTP 扩展头 “abs_send_time”</p></li>
<li><p>发送端：使用基于丢包的控制器， 可采用 <a class="reference external" href="webrtc_remb.html">Google REMB</a> 反馈估算的最大带宽和 RTCP Receiver Report 来反馈丢包及用来计算 RTT</p></li>
</ul>
</div>
<div class="section" id="id7">
<h2><a class="toc-backref" href="#id23">4. 发送引擎</a><a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h2>
<p>步行者 <cite>Pacing</cite> 用来驱动由控制器计算出的目标比特率</p>
<p>当媒体编码器产生数据时，会被送往一个步行者队列 (Pacer queue). 步行者 (Pacer) 每隔 burst_time 发送一组数据包到网络上。
推荐的 burst_time 为 5ms, 一组数据包的大小计算为目标比特率和 burst_time 的乘积。</p>
</div>
<div class="section" id="id8">
<h2><a class="toc-backref" href="#id24">5.  基于延迟的控制</a><a class="headerlink" href="#id8" title="Permalink to this headline">¶</a></h2>
<p>基于延迟的控制的算法主要分为四个部分：</p>
<ol class="arabic simple">
<li><p>pre-filtering 预先过滤</p></li>
<li><p>arrival-time filter 到达时间过滤器</p></li>
<li><p>over-use detector 过度使用检测器</p></li>
<li><p>rate-control 速率控制器</p></li>
</ol>
<div class="section" id="id9">
<h3><a class="toc-backref" href="#id25">5.1 到达时间模型</a><a class="headerlink" href="#id9" title="Permalink to this headline">¶</a></h3>
<p>两个包发送的间隔 T(i) – T(i-1) 和接收的间隔 t(i) – t(i-1) 在理想情况下是相同的，实际上会有不同.
也就是说包的到达时间并未保持稳定的速度。 在计算的时候可以用以帧分组，对两个组的到达时间进行计算。</p>
<ul class="simple">
<li><p>发送时间间隔与到达时间间隔之间的延时的观测公式，称为单向延迟变化</p></li>
</ul>
<div class="math notranslate nohighlight">
\[d(i) = t(i) – t(i-1) – (T(i) – T(i-1))\]</div>
<p>还可将数据包组之间的延迟变化建模为</p>
<div class="math notranslate nohighlight">
\[d(i) = w(i)\]</div>
<p>这里的 w(i) 是一个随机过程 W 的采样，它是一个连接容量，当前交叉流量和当前比特率的函数，我们将 W 建模为一个白高斯过程。如果我们过度使用了传输通道，则 w(i) 的平均值就会增大，如果网络路径中的拥塞队列已经清空了，这个 w(i) 的平均值就会减小，否则 w(i) 的平均值为零。</p>
<p>由此，我们可以将w(i) 分解为它的平均值加上一个偏差</p>
<div class="math notranslate nohighlight">
\[d(i) = m(i) + v(i)\]</div>
<p>v(i) 表示网络抖动和其他没有被这个模型捕捉到的延迟</p>
</div>
<div class="section" id="pre-filtering">
<h3><a class="toc-backref" href="#id26">5.2.  Pre-filtering 预先过滤</a><a class="headerlink" href="#pre-filtering" title="Permalink to this headline">¶</a></h3>
<p>预滤波旨在处理由信道中断引起的延迟瞬变。 在中断期间，由于与拥塞无关的原因，在网络缓冲区中排队的数据包会在中断结束时突发传送。</p>
<p>预过滤将突发到达的数据包组合并在一起。 如果满足以下两个条件之一，则数据包将合并到同一组中：</p>
<ul class="simple">
<li><p>在一个 burst_time 间隔内发送的数据包序列构成一个组。</p></li>
<li><p>具有小于 burst_time 的到达间隔时间和小于0 的组间延迟变化d(i) 的数据包被认为是当前数据包组的一部分。</p></li>
</ul>
<p>在 RTCP Sender Report 中有成对的 NTP timstamp 和 RTP timestamp， 这样就可以把 RTP 包中的 timestamp 转换为 NTP timstamp。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>           <span class="mi">0</span>                   <span class="mi">1</span>                   <span class="mi">2</span>                   <span class="mi">3</span>
           <span class="mi">0</span> <span class="mi">1</span> <span class="mi">2</span> <span class="mi">3</span> <span class="mi">4</span> <span class="mi">5</span> <span class="mi">6</span> <span class="mi">7</span> <span class="mi">8</span> <span class="mi">9</span> <span class="mi">0</span> <span class="mi">1</span> <span class="mi">2</span> <span class="mi">3</span> <span class="mi">4</span> <span class="mi">5</span> <span class="mi">6</span> <span class="mi">7</span> <span class="mi">8</span> <span class="mi">9</span> <span class="mi">0</span> <span class="mi">1</span> <span class="mi">2</span> <span class="mi">3</span> <span class="mi">4</span> <span class="mi">5</span> <span class="mi">6</span> <span class="mi">7</span> <span class="mi">8</span> <span class="mi">9</span> <span class="mi">0</span> <span class="mi">1</span>
       <span class="o">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>
<span class="n">header</span> <span class="o">|</span><span class="n">V</span><span class="o">=</span><span class="mi">2</span><span class="o">|</span><span class="n">P</span><span class="o">|</span>    <span class="n">RC</span>   <span class="o">|</span>   <span class="n">PT</span><span class="o">=</span><span class="n">SR</span><span class="o">=</span><span class="mi">200</span>   <span class="o">|</span>             <span class="n">length</span>            <span class="o">|</span>
       <span class="o">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>
       <span class="o">|</span>                         <span class="n">SSRC</span> <span class="n">of</span> <span class="n">sender</span>                        <span class="o">|</span>
       <span class="o">+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+</span>
<span class="n">sender</span> <span class="o">|</span>              <span class="n">NTP</span> <span class="n">timestamp</span><span class="p">,</span> <span class="n">most</span> <span class="n">significant</span> <span class="n">word</span>             <span class="o">|</span>
<span class="n">info</span>   <span class="o">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>
       <span class="o">|</span>             <span class="n">NTP</span> <span class="n">timestamp</span><span class="p">,</span> <span class="n">least</span> <span class="n">significant</span> <span class="n">word</span>             <span class="o">|</span>
       <span class="o">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>
       <span class="o">|</span>                         <span class="n">RTP</span> <span class="n">timestamp</span>                         <span class="o">|</span>
       <span class="o">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>
       <span class="o">|</span>                     <span class="n">sender</span><span class="s1">&#39;s packet count                     |</span>
       <span class="o">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>
       <span class="o">|</span>                      <span class="n">sender</span><span class="s1">&#39;s octet count                     |</span>
       <span class="o">+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+</span>
<span class="n">report</span> <span class="o">|</span>                 <span class="n">SSRC_1</span> <span class="p">(</span><span class="n">SSRC</span> <span class="n">of</span> <span class="n">first</span> <span class="n">source</span><span class="p">)</span>                 <span class="o">|</span>
<span class="n">block</span>  <span class="o">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>
  <span class="mi">1</span>    <span class="o">|</span> <span class="n">fraction</span> <span class="n">lost</span> <span class="o">|</span>       <span class="n">cumulative</span> <span class="n">number</span> <span class="n">of</span> <span class="n">packets</span> <span class="n">lost</span>       <span class="o">|</span>
       <span class="o">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>
       <span class="o">|</span>           <span class="n">extended</span> <span class="n">highest</span> <span class="n">sequence</span> <span class="n">number</span> <span class="n">received</span>           <span class="o">|</span>
       <span class="o">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>
       <span class="o">|</span>                      <span class="n">interarrival</span> <span class="n">jitter</span>                      <span class="o">|</span>
       <span class="o">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>
       <span class="o">|</span>                         <span class="n">last</span> <span class="n">SR</span> <span class="p">(</span><span class="n">LSR</span><span class="p">)</span>                         <span class="o">|</span>
       <span class="o">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>
       <span class="o">|</span>                   <span class="n">delay</span> <span class="n">since</span> <span class="n">last</span> <span class="n">SR</span> <span class="p">(</span><span class="n">DLSR</span><span class="p">)</span>                  <span class="o">|</span>
       <span class="o">+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+</span>
<span class="n">report</span> <span class="o">|</span>                 <span class="n">SSRC_2</span> <span class="p">(</span><span class="n">SSRC</span> <span class="n">of</span> <span class="n">second</span> <span class="n">source</span><span class="p">)</span>                <span class="o">|</span>
<span class="n">block</span>  <span class="o">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>
  <span class="mi">2</span>    <span class="p">:</span>                               <span class="o">...</span>                             <span class="p">:</span>
       <span class="o">+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+</span>
       <span class="o">|</span>                  <span class="n">profile</span><span class="o">-</span><span class="n">specific</span> <span class="n">extensions</span>                  <span class="o">|</span>
       <span class="o">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>
</pre></div>
</div>
<p>接收端控制器是一种基于延迟的拥塞控制算法，通过下面的公式来计算 <span class="math notranslate nohighlight">\(A_r\)</span></p>
<div class="math notranslate nohighlight">
\[A_{r}(t_{i})=\cases{\eta A_{r}(t_{i-1}) &amp; ${\rm Increase}$\cr \alpha R(t_{i}) &amp; ${\rm Decrease}$\cr A(t_{i-1}) &amp; ${\rm Hold}$}\]</div>
</div>
<div class="section" id="arrival-time-filter">
<h3><a class="toc-backref" href="#id27">5.3 到达时间滤波器 arrival time filter</a><a class="headerlink" href="#arrival-time-filter" title="Permalink to this headline">¶</a></h3>
<p>根据到达时间模型，我们可以通过 Kalman Filter 或者 Trendline Filter 来求得网络排队延迟 <cite>m(i)</cite></p>
<div class="math notranslate nohighlight">
\[ \begin{align}\begin{aligned}m(i+1) = m(i) + u(i)\\q(i) = E{u(i)^2}\\d(i) = m(i) + v(i)\end{aligned}\end{align} \]</div>
<p>其中</p>
<ul class="simple">
<li><p>q(i) 为状态噪声 u(i) 方差的期望，推荐值是 10^-3</p></li>
<li><p>u(i) 是指状态噪声, 把它建模为具有零均值和方差的高斯统计模拟的平稳过程</p></li>
<li><p>v(i) 是指测量噪声，它是具有方差 <cite>var_v = E{v(i)^2}</cite> 的零均值高斯白测量噪声</p></li>
</ul>
<p>注：
* 中心化（又叫零均值化）：是指变量減去它的均值。其实就是一个平移的过程，平移后所有数据的中心是（0，0）。
* 标准化（又叫归一化）： 是指數值減去均值，再除以标准差。</p>
<p>卡尔曼滤波器递归地更新这个估计值 m_hat(i)</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">z</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="n">d</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">-</span> <span class="n">m_hat</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

<span class="n">m_hat</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="n">m_hat</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">z</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">*</span> <span class="n">k</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

                   <span class="n">e</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">q</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
<span class="n">k</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="o">----------------------------------------</span>
           <span class="n">var_v_hat</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">e</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">q</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>

<span class="n">e</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">k</span><span class="p">(</span><span class="n">i</span><span class="p">))</span> <span class="o">*</span> <span class="p">(</span><span class="n">e</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">q</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>

<span class="n">var_v_hat</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">alpha</span> <span class="o">*</span> <span class="n">var_v_hat</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">alpha</span><span class="p">)</span> <span class="o">*</span> <span class="n">z</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">^</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">alpha</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">chi</span><span class="p">)</span><span class="o">^</span><span class="p">(</span><span class="mi">30</span><span class="o">/</span><span class="p">(</span><span class="mi">1000</span> <span class="o">*</span> <span class="n">f_max</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="section" id="the-over-use-detector">
<h3><a class="toc-backref" href="#id28">5.4 过度使用检测器 The over-use detector</a><a class="headerlink" href="#the-over-use-detector" title="Permalink to this headline">¶</a></h3>
<p>每次接收到视频帧 <span class="math notranslate nohighlight">\(t_i\)</span> 时，过度使用检测器都会产生一个信号 s，该信号基于排队延迟 <span class="math notranslate nohighlight">\(m(t_i)\)</span> 和阈值 <span class="math notranslate nohighlight">\(\gamma\)</span> 来驱动 FSM (下面的有限状态机) 的状态 <span class="math notranslate nohighlight">\(\sigma\)</span>，算法 1 详细显示了 s 是如何生成的 ：</p>
<p>当 <span class="math notranslate nohighlight">\(m(t_i) &gt; \gamma\)</span> 时，算法通过增加帧间隔时间 <span class="math notranslate nohighlight">\(\Delta T\)</span> 的变量 <span class="math notranslate nohighlight">\(t_{OU}\)</span> 来跟踪在这种情况下花费的时间。
当 <span class="math notranslate nohighlight">\(t_{OU}\)</span> 达到 <span class="math notranslate nohighlight">\(\bar{t}_{OU}=100ms\)</span> 且 <span class="math notranslate nohighlight">\(m(t_i) &gt; m(t_{i-1})\)</span> 时，产生过度使用信号。</p>
<p>另一方面，如果 <span class="math notranslate nohighlight">\(m(t_i)\)</span> 减小到 <span class="math notranslate nohighlight">\(\gamma\)</span> 以下，则产生未充分利用信号，而当 <span class="math notranslate nohighlight">\(-\gamma \leq m(t_i) \leq \gamma\)</span> 时触发正常信号。</p>
<div class="figure align-center" id="id17">
<a class="reference internal image-reference" href="../_images/rate-controller-fsm.gif"><img alt="remote rate controller finite state machine" src="../_images/rate-controller-fsm.gif" style="width: 495.0px; height: 142.20000000000002px;" /></a>
<p class="caption"><span class="caption-text">remote rate controller finite state machine</span><a class="headerlink" href="#id17" title="Permalink to this image">¶</a></p>
</div>
<ul class="simple">
<li><p>算法: Over-use Detector pseudo-code 过度使用检测器的伪代码</p></li>
</ul>
<div class="figure align-center" id="id18">
<a class="reference internal image-reference" href="../_images/over-use-detector-pseudo-code.gif"><img alt="over-use detector pseudo code" src="../_images/over-use-detector-pseudo-code.gif" style="width: 438.3px; height: 495.0px;" /></a>
<p class="caption"><span class="caption-text">over-use detector pseudo code</span><a class="headerlink" href="#id18" title="Permalink to this image">¶</a></p>
</div>
</div>
<div class="section" id="rate-controller">
<h3><a class="toc-backref" href="#id29">5.5 Rate controller</a><a class="headerlink" href="#rate-controller" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><p>The rate control is split in two parts,</p>
</div></blockquote>
<ol class="arabic simple">
<li><p>controlling the bandwidth estimate based on delay</p></li>
<li><p>controlling the bandwidth estimate based on loss</p></li>
</ol>
<ul class="simple">
<li><p>The state transitions (with blank fields meaning “remain in state”)</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">+----+--------+-----------+------------+--------+</span>
<span class="o">|</span>     \ <span class="n">State</span> <span class="o">|</span>   <span class="n">Hold</span>    <span class="o">|</span>  <span class="n">Increase</span>  <span class="o">|</span><span class="n">Decrease</span><span class="o">|</span>
<span class="o">|</span>      \      <span class="o">|</span>           <span class="o">|</span>            <span class="o">|</span>        <span class="o">|</span>
<span class="o">|</span> <span class="n">Signal</span>\     <span class="o">|</span>           <span class="o">|</span>            <span class="o">|</span>        <span class="o">|</span>
<span class="o">+--------+----+-----------+------------+--------+</span>
<span class="o">|</span>  <span class="n">Over</span><span class="o">-</span><span class="n">use</span>   <span class="o">|</span> <span class="n">Decrease</span>  <span class="o">|</span>  <span class="n">Decrease</span>  <span class="o">|</span>        <span class="o">|</span>
<span class="o">+-------------+-----------+------------+--------+</span>
<span class="o">|</span>  <span class="n">Normal</span>     <span class="o">|</span> <span class="n">Increase</span>  <span class="o">|</span>            <span class="o">|</span>  <span class="n">Hold</span>  <span class="o">|</span>
<span class="o">+-------------+-----------+------------+--------+</span>
<span class="o">|</span>  <span class="n">Under</span><span class="o">-</span><span class="n">use</span>  <span class="o">|</span>           <span class="o">|</span>   <span class="n">Hold</span>     <span class="o">|</span>  <span class="n">Hold</span>  <span class="o">|</span>
<span class="o">+-------------+-----------+------------+--------+</span>
</pre></div>
</div>
</div>
<div class="section" id="parameters-settings">
<h3><a class="toc-backref" href="#id30">5.6 Parameters settings</a><a class="headerlink" href="#parameters-settings" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">+-----------------+-----------------------------------+-------------+</span>
<span class="o">|</span> <span class="n">Parameter</span>       <span class="o">|</span> <span class="n">Description</span>                       <span class="o">|</span> <span class="n">RECOMMENDED</span> <span class="o">|</span>
<span class="o">|</span>                 <span class="o">|</span>                                   <span class="o">|</span> <span class="n">Value</span>       <span class="o">|</span>
<span class="o">+-----------------+-----------------------------------+-------------+</span>
<span class="o">|</span> <span class="n">burst_time</span>      <span class="o">|</span> <span class="n">Time</span> <span class="n">limit</span> <span class="ow">in</span> <span class="n">milliseconds</span>        <span class="o">|</span> <span class="mi">5</span> <span class="n">ms</span>        <span class="o">|</span>
<span class="o">|</span>                 <span class="o">|</span> <span class="n">between</span> <span class="n">packet</span> <span class="n">bursts</span> <span class="n">which</span>       <span class="o">|</span>             <span class="o">|</span>
<span class="o">|</span>                 <span class="o">|</span> <span class="n">identifies</span> <span class="n">a</span> <span class="n">group</span>                <span class="o">|</span>             <span class="o">|</span>
<span class="o">|</span> <span class="n">q</span>               <span class="o">|</span> <span class="n">State</span> <span class="n">noise</span> <span class="n">covariance</span> <span class="n">matrix</span>     <span class="o">|</span> <span class="n">q</span> <span class="o">=</span> <span class="mi">10</span><span class="o">^-</span><span class="mi">3</span>   <span class="o">|</span>
<span class="o">|</span> <span class="n">e</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>            <span class="o">|</span> <span class="n">Initial</span> <span class="n">value</span> <span class="n">of</span> <span class="n">the</span>  <span class="n">system</span>      <span class="o">|</span> <span class="n">e</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.1</span>  <span class="o">|</span>
<span class="o">|</span>                 <span class="o">|</span> <span class="n">error</span> <span class="n">covariance</span>                  <span class="o">|</span>             <span class="o">|</span>
<span class="o">|</span> <span class="n">chi</span>             <span class="o">|</span> <span class="n">Coefficient</span> <span class="n">used</span>  <span class="k">for</span> <span class="n">the</span>         <span class="o">|</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span>       <span class="o">|</span>
<span class="o">|</span>                 <span class="o">|</span> <span class="n">measured</span> <span class="n">noise</span> <span class="n">variance</span>           <span class="o">|</span> <span class="mf">0.001</span><span class="p">]</span>      <span class="o">|</span>
<span class="o">|</span> <span class="n">del_var_th</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>   <span class="o">|</span> <span class="n">Initial</span> <span class="n">value</span> <span class="k">for</span> <span class="n">the</span> <span class="n">adaptive</span>    <span class="o">|</span> <span class="mf">12.5</span> <span class="n">ms</span>     <span class="o">|</span>
<span class="o">|</span>                 <span class="o">|</span> <span class="n">threshold</span>                         <span class="o">|</span>             <span class="o">|</span>
<span class="o">|</span> <span class="n">overuse_time_th</span> <span class="o">|</span> <span class="n">Time</span> <span class="n">required</span> <span class="n">to</span> <span class="n">trigger</span> <span class="n">an</span>       <span class="o">|</span> <span class="mi">10</span> <span class="n">ms</span>       <span class="o">|</span>
<span class="o">|</span>                 <span class="o">|</span> <span class="n">overuse</span> <span class="n">signal</span>                    <span class="o">|</span>             <span class="o">|</span>
<span class="o">|</span> <span class="n">K_u</span>             <span class="o">|</span> <span class="n">Coefficient</span> <span class="k">for</span> <span class="n">the</span> <span class="n">adaptive</span>      <span class="o">|</span> <span class="mf">0.01</span>        <span class="o">|</span>
<span class="o">|</span>                 <span class="o">|</span> <span class="n">threshold</span>                         <span class="o">|</span>             <span class="o">|</span>
<span class="o">|</span> <span class="n">K_d</span>             <span class="o">|</span> <span class="n">Coefficient</span> <span class="k">for</span> <span class="n">the</span> <span class="n">adaptive</span>      <span class="o">|</span> <span class="mf">0.00018</span>     <span class="o">|</span>
<span class="o">|</span>                 <span class="o">|</span> <span class="n">threshold</span>                         <span class="o">|</span>             <span class="o">|</span>
<span class="o">|</span> <span class="n">T</span>               <span class="o">|</span> <span class="n">Time</span> <span class="n">window</span> <span class="k">for</span> <span class="n">measuring</span> <span class="n">the</span>     <span class="o">|</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="n">s</span>  <span class="o">|</span>
<span class="o">|</span>                 <span class="o">|</span> <span class="n">received</span> <span class="n">bitrate</span>                  <span class="o">|</span>             <span class="o">|</span>
<span class="o">|</span> <span class="n">beta</span>            <span class="o">|</span> <span class="n">Decrease</span> <span class="n">rate</span> <span class="n">factor</span>              <span class="o">|</span> <span class="mf">0.85</span>        <span class="o">|</span>
<span class="o">+-----------------+-----------------------------------+-------------+</span>

       <span class="n">Table</span> <span class="mi">1</span><span class="p">:</span> <span class="n">RECOMMENDED</span> <span class="n">values</span> <span class="k">for</span> <span class="n">delay</span> <span class="n">based</span> <span class="n">controller</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="loss-based-control">
<h2><a class="toc-backref" href="#id31">6. 基于丢包的控制器 Loss-based control</a><a class="headerlink" href="#loss-based-control" title="Permalink to this headline">¶</a></h2>
<p>发送端控制器是一种基于丢失的拥塞控制算法，它在每次 tk 第 k 个 RTCP 报告消息到达发送方或每次 tr 携带 Ar 的第 r 个 REMB 消息到达发送方时起作用。 RTCP 报告的发送频率是可变的，它取决于反向路径的可用带宽； 反向路径可用带宽越高，RTCP 报告频率越高。 REMB 格式是 RTCP 协议 [20] 的扩展，RMCAT WG 正在讨论该协议（另见第 III-B 节）。 RTCP 报告包括如 [20] 中所述计算的丢失数据包比例 fl(tk)。 发送方使用 fl(tk) 计算发送速率 As(tk)，以 kbps 为单位，根据以下等式：</p>
<div class="math notranslate nohighlight">
\[A_{s}(t_{k})=\cases{\max\{X(t_{k}), A_{s}(t_{k-1})(1-0.5f_{l}(t_{k}))\} &amp; $f_{l}(t_{k})&gt;0.1$\cr 1.05\ (\ A_{s}(t_{k-1})+\ 1{\rm kbps}) &amp; $f_{l}(t_{k})&lt;0.02$\cr A_{s}(t_{k-1}) &amp; ${\rm otherwise}$}\]</div>
<p>1）当丢包率 &lt; 2% 时，这个时候会将码率（base bitrate）增长 5%</p>
<p>这个码率(base bitrate)并不是当前及时码率，而是单位时间窗周期内出现的最小码率,WebRTC将这个时间窗周期设置在1000毫秒内。因为loss fraction是从接收端反馈过来的，中间会有时间差，这样做的目的是防止网络间歇性统计造成的网络码率增长过快而网络反复波动。</p>
<p>2）当丢包率在 [2%, 10%] 之间,维持当前的码率值</p>
<p>3）当 丢包率 &gt; 10%, 按丢包率进行当前码率递减，等到新的码率值</p>
<p>丢包率决策出来的码率（base bitrate）只是一个参考值，WebRTC实际采用的带宽是base bitrate、remb bitrate和 bwe bitrate中的最小值，这个最小值作为estimator最终评估出来的码率</p>
</div>
<div class="section" id="id10">
<h2><a class="toc-backref" href="#id32">参考代码</a><a class="headerlink" href="#id10" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p><a class="reference external" href="https://source.chromium.org/chromium/chromium/src/+/main:third_party/webrtc/modules/">https://source.chromium.org/chromium/chromium/src/+/main:third_party/webrtc/modules/</a>
- congestion_controller/
- remote_bitrate_estimator/</p></li>
</ul>
</div>
<div class="section" id="id11">
<h2><a class="toc-backref" href="#id33">参考资料</a><a class="headerlink" href="#id11" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p><a class="reference external" href="https://www.cnblogs.com/wangyiyunxin/p/11122003.html">GCC Introduction</a></p></li>
<li><p><a class="reference external" href="https://mp.weixin.qq.com/s/Ej63-FTe5-2pkxyXoXBUTw">WebRTC的拥塞控制和带宽策略</a></p></li>
<li><p><a class="reference external" href="http://www.jianshu.com/p/bb34995c549a">WebRTC视频接收缓冲区基于KalmanFilter的延迟模型</a></p></li>
<li><p><a class="reference external" href="https://www.jianshu.com/p/0f7ee0e0b3be">WebRTC基于GCC的拥塞控制(上) - 算法分析</a></p></li>
<li><p><a class="reference external" href="https://www.jianshu.com/p/5259a8659112">WebRTC基于GCC的拥塞控制(下) - 实现分析</a></p></li>
<li><p><a class="reference external" href="https://mp.weixin.qq.com/s/Ej63-FTe5-2pkxyXoXBUTw">WebRTC的拥塞控制和带宽策略</a></p></li>
</ul>
<dl class="footnote brackets">
<dt class="label" id="id14"><span class="brackets"><a class="fn-backref" href="#id2">1</a></span></dt>
<dd><p><a class="reference external" href="https://datatracker.ietf.org/doc/html/draft-ietf-rmcat-gcc-02">A Google Congestion Control Algorithm for Real-Time Communication</a> （draft-ietf-rmcat-gcc-02）</p>
</dd>
<dt class="label" id="id15"><span class="brackets"><a class="fn-backref" href="#id3">2</a></span></dt>
<dd><p><a class="reference external" href="https://ieeexplore.ieee.org/document/6691458">Understanding the Dynamic Behaviour of the Google Congestion Control for RTCWeb</a></p>
</dd>
</dl>
</div>
</div>


           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2021, walter.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
  
 <script type="text/javascript">
    $(document).ready(function() {
        $(".toggle > *").hide();
        $(".toggle .header").show();
        $(".toggle .header").click(function() {
            $(this).parent().children().not(".header").toggle(400);
            $(this).parent().children(".header").toggleClass("open");
        })
    });
</script>


</body>
</html>